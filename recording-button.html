<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html" rel="import">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/av-icons.html">
<link rel="import" href="bower_components/audio-player/audio-player.html">

<dom-module id="recording-button">
    <template>
        <style>
            :host {
                display : block;
            }

            .wrapper {
                display       : inline-block;
                padding       : 10px 20px;
                border        : 1px solid #2f9c0a;
                border-radius : 4px;
            }

            .wrapper .time-wrapper {
                display          : inline-block;
                padding          : 5px 20px;
                background-color : #eeeeee;
                border-radius    : 10px;
            }

            .wrapper .time-wrapper .time {
                color : #888888;
            }

        </style>

        <audio-player id="player" src="{{_recordingSoundUrl}}" volume="5"></audio-player>

        <div class="wrapper">
            <paper-icon-button icon="av:mic" disabled="{{isDisableMic}}" on-click="clickMic"></paper-icon-button>
            <paper-icon-button icon="av:fiber-manual-record" disabled="{{_isDisableRecording}}" on-click="clickRecording"></paper-icon-button>
            <paper-icon-button icon="av:play-arrow" disabled="{{isDisablePlay}}" on-click="clickPlay"></paper-icon-button>
            <paper-icon-button icon="av:stop" disabled="{{isDisableStop}}" on-click="clickStop"></paper-icon-button>
            <div class="time-wrapper">
                <div class="time">{{time_string}}</div>
            </div>
            <paper-icon-button icon="icons:file-download"></paper-icon-button>
        </div>

    </template>

    <script>
        /**
         * `recording-button`
         * This is button for recording sound
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class RecordingButton extends Polymer.Element {
            static get is () { return 'recording-button'; }

            static get properties () {
                return {
                    time         : {
                        type    : Number,
                        value   : 0,
                        observer: '_timeChanged'
                    },
                    time_string  : {
                        type : String,
                        value: '0:00:00'
                    },
                    interval_id  : {
                        type : Number,
                        value: 0
                    },
                    isDisableMic : {
                        type : Boolean,
                        value: false
                    },
                    isRecording  : {
                        type    : Boolean,
                        value   : false,
                        observer: '_isRecording'
                    },
                    isDisablePlay: {
                        type : Boolean,
                        value: false
                    },
                    isDisableStop: {
                        type : Boolean,
                        value: true
                    }
                };
            }

            constructor () {
                super ();

                this._recordedChunks = [];
            }

            ready () {
                super.ready ();

                // player
                this._audioPlayer = this.shadowRoot.querySelector ('#player');

                // player End Event
                this._audioPlayer.onend = (e) => {
                    this.clickStop ();
                };

                // getUserMedia
                if (!navigator.mediaDevices) {
                    this.isDisableMic = false;
                    console.log ('getUserMedia() not supported.');
                    return;
                }

                navigator.mediaDevices.getUserMedia ({audio: true})
                    .then ((stream) => {
                        this.isDisableMic = true;

                        // Media Recorder
                        this._mediaRecorder = new MediaRecorder (stream, {mimeType: 'audio/webm'});

                        // Media Recorder Data available
                        this._mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                this._recordedChunks.push (event.data);
                            }
                        };

                        // Media Recorder Error
                        this._mediaRecorder.onerror = (error) => {
                            console.error (error);
                        };

                        // Media Recorder Start
                        this._mediaRecorder.onstart = (e) => {
                            this.isRecording = true;
                        };

                        // Media Recorder Stop
                        this._mediaRecorder.onstop = (e) => {
                            this.isRecording = false;

                            const superBuffer = new Blob (this._recordedChunks);

                            this._recordedChunks = [];

                            this._recordingSoundUrl = window.URL.createObjectURL (superBuffer);
                        }
                    })
                    .catch ((err) => {
                        this.isDisableMic = false;
                        console.log (err.name + ': ' + err.message);
                    });
            }

            start () {
                this.interval_id = setInterval (() => {
                    this.time = this.time + 10;
                }, 10);
            }

            static createTime (time) {
                const hour = Math.floor (time / (60 * 60 * 1000));
                time = time - (hour * 60 * 60 * 1000);

                const min = Math.floor (time / (60 * 1000));
                time = time - (min * 60 * 1000);

                const sec = Math.floor (time / 1000);

                const hour_s = hour;
                const min_s = ('00' + min).slice (-2);
                const sec_s = ('00' + sec).slice (-2);

                return hour_s + ':' + min_s + ':' + sec_s;
            }

            clickMic () {
                this.isDisableMic = !this.isDisableMic;
            }

            clickRecording () {
                // Not enable when unable mic
                if (!this.isDisableMic) {
                    return;
                }

                this.isDisablePlay = true;
                this.isDisableStop = false;

                // Recording Start
                if (!this.isRecording) {
                    this._mediaRecorder.start ();
                }

                // timer start
                this.start ();
            }

            clickPlay () {
                // Not enable when recording
                if (this.isRecording) {
                    return;
                }

                this.isDisablePlay = true;
                this.isDisableStop = false;

                // play of recorded audio
                this._audioPlayer._play ();

                // timer start
                this.start ();
            }

            clickStop () {
                // Recording Stop
                if (this.isRecording) {
                    this._mediaRecorder.stop ();
                }

                this.isDisablePlay = false;
                this.isDisableStop = true;

                clearInterval (this.interval_id);
                this.time = 0;
            }

            /**
             * Observer
             */
            _timeChanged (val) {
                this.time_string = RecordingButton.createTime (val);
            }

            _isRecording (val) {
                if (val) {
                    this._isDisableRecording = true;
                }
                else {
                    this._isDisableRecording = false;
                }
            }
        }

        window.customElements.define (RecordingButton.is, RecordingButton);
    </script>
</dom-module>
