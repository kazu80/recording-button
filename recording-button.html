<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/av-icons.html">
<link rel="import" href="../audio-player/audio-player.html">

<dom-module id="recording-button">
    <template>
        <style>
            :host {
                --control-wrapper: {
                    padding       : 10px 20px;
                    border        : 1px solid #888888;
                    border-radius : 4px;
                };

                --time-wrapper: {
                    padding          : 5px 20px;
                    background-color : #eeeeee;
                    border-radius    : 10px;
                };

                --time: {
                    color : #888888;
                };

                --buttons: {
                };

                --buttons-disabled: {
                };

                --button-mic: {
                };

                --button-mic-disabled: {
                };

                --button-rec: {
                    color : #ff0006;
                };

                --button-rec-disabled: {
                    color : #ff6f6f;
                };

                --button-play: {
                };

                --button-play-disabled: {
                };

                --button-stop: {
                };

                --button-stop-disabled: {
                };

                --button-dl: {
                };

                --button-dl-disabled: {
                };
            }

            .control-wrapper {
                display : inline-block;
                @apply --control-wrapper;
            }

            .time-wrapper {
                display : inline-block;
                @apply --time-wrapper;
            }

            .time {
                @apply --time;
            }

            .buttons {
                @apply --buttons;
            }

            .buttons[disabled] {
                @apply --buttons;
                @apply --buttons-disabled;
            }

            .button-mic {
                @apply --button-mic;
            }

            .button-mic[disabled] {
                @apply --button-mic;
                @apply --button-mic-disabled;
            }

            .button-rec {
                @apply --button-rec;
            }

            .button-rec[disabled] {
                @apply --button-rec;
                @apply --button-rec-disabled;
            }

            .button-play {
                @apply --button-play;
            }

            .button-play[disabled] {
                @apply --button-play;
                @apply --button-play-disabled;
            }

            .button-stop {
                @apply --button-stop;
            }

            .button-stop[disabled] {
                @apply --button-stop;
                @apply --button-stop-disabled;
            }

            .button-dl {
                @apply --button-dl;
            }

            .button-dl[disabled] {
                @apply --button-dl;
                @apply --button-dl-disabled;
            }
        </style>

        <audio-player id="player" src="{{recordingSoundUrl}}" volume="5"></audio-player>
        <a id="download" href="{{recordingSoundUrl}}" download="{{_downloadFile}}" style="display: none"></a>

        <div class="control-wrapper">
            <paper-icon-button class="buttons button-mic" icon="av:mic" disabled="{{isDisableMic}}" on-click="clickMic"></paper-icon-button>
            <paper-icon-button class="buttons button-rec" icon="av:fiber-manual-record" disabled="{{_isDisableRecording}}" on-click="clickRecording"></paper-icon-button>
            <paper-icon-button class="buttons button-play" icon="av:play-arrow" disabled="{{isDisablePlay}}" on-click="clickPlay"></paper-icon-button>
            <paper-icon-button class="buttons button-stop" icon="av:stop" disabled="{{isDisableStop}}" on-click="clickStop"></paper-icon-button>
            <div class="time-wrapper">
                <div class="time">{{time_string}}</div>
            </div>
            <paper-icon-button class="buttons button-dl" icon="icons:file-download" disabled="{{isDisableDownload}}" on-click="clickDownload"></paper-icon-button>
        </div>

    </template>

    <script>
        /**
         * `recording-button`
         * This is button for recording sound
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class RecordingButton extends Polymer.Element {
            static get is () { return 'recording-button'; }

            static get properties () {
                return {
                    time             : {
                        type    : Number,
                        value   : 0,
                        observer: '_timeChanged'
                    },
                    time_string      : {
                        type : String,
                        value: '0:00:00'
                    },
                    interval_id      : {
                        type : Number,
                        value: 0
                    },
                    isMic            : {
                        type    : Boolean,
                        value   : false,
                        observer: '_isMic'
                    },
                    isDisableMic     : {
                        type : Boolean,
                        value: false
                    },
                    isRecording      : {
                        type    : String,
                        value   : null,
                        observer: '_isRecording'
                    },
                    isDisablePlay    : {
                        type : Boolean,
                        value: true
                    },
                    isDisableStop    : {
                        type : Boolean,
                        value: true
                    },
                    isDisableDownload: {
                        type : Boolean,
                        value: true
                    },
                    recordingSoundUrl: {
                        type    : String,
                        value   : null,
                        observer: '_recordingSoundUrlChange'
                    }
                };
            }

            constructor () {
                super ();

                this._recordedChunks = [];

                /**
                 * Callbacks
                 */
                this._callbackGetUserMedia = (stream) => {
                    this.isMic = true;
                    this.isRecording = 'off';

                    // Media Recorder
                    this._mediaRecorder = new MediaRecorder (stream, {mimeType: 'audio/webm'});

                    // Media Recorder Data available
                    this._mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this._recordedChunks.push (event.data);
                        }
                    };

                    // Media Recorder Error
                    this._mediaRecorder.onerror = (error) => {
                        console.error (error);
                    };

                    // Media Recorder Start
                    this._mediaRecorder.onstart = (e) => {
                        this.isRecording = 'on';
                    };

                    // Media Recorder Stop
                    this._mediaRecorder.onstop = (e) => {
                        this.isRecording = 'off';

                        const superBuffer = new Blob (this._recordedChunks);

                        this._recordedChunks = [];

                        // Set URL for download
                        this.recordingSoundUrl = window.URL.createObjectURL (superBuffer);

                        // Set name of download file
                        this._downloadFile = RecordingButton.getDownloadFileName ();
                    }
                };

                this._callbackGetUserMediaError = (err) => {
                    this.isDisableMic = false;
                    this.isDisablePlay = true;
                    this.isDisableStop = true;
                    this.isDisableDownload = true;

                    console.error (err.name + ': ' + err.message);
                };
            }

            ready () {
                super.ready ();

                // download
                this._download = this.shadowRoot.querySelector ('#download');

                // player
                this._audioPlayer = this.shadowRoot.querySelector ('#player');

                // player End Event
                this._audioPlayer.onend = (e) => {
                    this.clickStop ();
                };

                // getUserMedia
                if (!navigator.mediaDevices) {
                    this.isDisableMic = false;
                    this.isRecording = null;
                    this.isDisablePlay = true;
                    this.isDisableStop = true;
                    this.isDisableDownload = true;

                    console.error ('getUserMedia() not supported.');
                    return;
                }

                navigator.mediaDevices.getUserMedia ({audio: true})
                    .then (this._callbackGetUserMedia)
                    .catch (this._callbackGetUserMediaError);
            }

            start () {
                this.interval_id = setInterval (() => {
                    this.time = this.time + 10;
                }, 10);
            }

            clickMic () {
                navigator.mediaDevices.getUserMedia ({audio: true})
                    .then (this._callbackGetUserMedia)
                    .catch (this._callbackGetUserMediaError);
            }

            clickRecording () {
                // Not enable when unable mic
                if (!this.isDisableMic) {
                    this.isRecording = null;
                    return;
                }

                this.isDisablePlay = true;
                this.isDisableStop = false;

                // Recording Start
                if (this.isRecording === 'off') {
                    this._mediaRecorder.start ();
                }

                // timer start
                this.start ();
            }

            clickPlay () {
                // Not enable when recording
                if (this.isRecording === 'on') {
                    return;
                }

                this.isDisablePlay = true;
                this.isDisableStop = false;

                // play of recorded audio
                this._audioPlayer._play ();

                // timer start
                this.start ();
            }

            clickStop () {
                // Recording Stop
                if (this.isRecording === 'on') {
                    this._mediaRecorder.stop ();
                }

                this.isDisablePlay = false;
                this.isDisableStop = true;

                clearInterval (this.interval_id);
                this.time = 0;
            }

            clickDownload () {
                this._download.click ();
            }

            /**
             * Static methods
             */
            static createTime (time) {
                const hour = Math.floor (time / (60 * 60 * 1000));
                time = time - (hour * 60 * 60 * 1000);

                const min = Math.floor (time / (60 * 1000));
                time = time - (min * 60 * 1000);

                const sec = Math.floor (time / 1000);

                const hour_s = hour;
                const min_s = ('00' + min).slice (-2);
                const sec_s = ('00' + sec).slice (-2);

                return hour_s + ':' + min_s + ':' + sec_s;
            }

            static getDownloadFileName () {
                const now = new Date ();
                const y = now.getFullYear ();
                const m = (`00${now.getMonth () + 1}`).slice (-2);
                const d = (`00${now.getDate ()}`).slice (-2);
                const hour = (`00${now.getHours ()}`).slice (-2);
                const min = (`00${now.getMinutes ()}`).slice (-2);
                const sec = (`00${now.getSeconds ()}`).slice (-2);
                return `recording-${y}${m}${d}${hour}${min}${sec}.webm`;
            }

            /**
             * Observer
             */
            _timeChanged (val) {
                this.time_string = RecordingButton.createTime (val);
            }

            _isMic (val) {
                this.isDisableMic = !!val;

                if (val) {
                    this.isRecording = 'ready';
                    this.isDisablePlay = true;
                    this.isDisableStop = true;
                    this.isDisableDownload = true;
                } else {
                    this.isRecording = null;
                    this.isDisablePlay = true;
                    this.isDisableStop = true;
                    this.isDisableDownload = true;
                }

            }

            _isRecording (val) {
                switch (val) {
                    case 'ready':
                        this._isDisableRecording = false;
                        break;
                    case 'on':
                        this._isDisableRecording = true;
                        break;
                    case 'off':
                        this._isDisableRecording = false;
                        break;
                    default :
                        this._isDisableRecording = true;
                        break;
                }
            }

            _recordingSoundUrlChange (val) {
                this.isDisableDownload = !val;
            }
        }

        window.customElements.define (RecordingButton.is, RecordingButton);
    </script>
</dom-module>
